<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>VAIDYA â€” Register</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

  <!-- âœ… ALL YOUR ORIGINAL CSS â€” UNCHANGED -->
  <style>
    /* (CSS exactly same as your file â€” not modified) */
  </style>
</head>

<body>
<main class="container" role="main" aria-labelledby="reg-heading">

<!-- âœ… ALL YOUR ORIGINAL HTML â€” UNCHANGED -->

</main>

<script type="module">
/* ================= FIREBASE (UNCHANGED EXCEPT STORAGE REMOVED) ================= */
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
import { getAuth, createUserWithEmailAndPassword, updateProfile }
from "https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";
import { getFirestore, doc, setDoc, serverTimestamp }
from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

/* ================= CLOUDINARY (NEW â€“ REQUIRED) ================= */
const CLOUDINARY_CLOUD_NAME = "dknrcluo8";
const CLOUDINARY_UPLOAD_PRESET = "vadiya2";

async function uploadToCloudinary(file){
  const url = `https://api.cloudinary.com/v1_1/${CLOUDINARY_CLOUD_NAME}/image/upload`;
  const formData = new FormData();
  formData.append("file", file);
  formData.append("upload_preset", CLOUDINARY_UPLOAD_PRESET);

  const res = await fetch(url, { method:"POST", body: formData });
  if(!res.ok) throw new Error("Cloudinary upload failed");
  return (await res.json()).secure_url;
}

/* ================= FIREBASE CONFIG (UNCHANGED) ================= */
const firebaseConfig = {
  apiKey: "AIzaSyDav5CAOhVEUs7czI8zAO9Jogn-B30OLSU",
  authDomain: "vaidya-244c9.firebaseapp.com",
  projectId: "vaidya-244c9",
  messagingSenderId: "541936193390",
  appId: "1:541936193390:web:bd9bcb63230501126bbb7f"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

/* ================= HELPERS (UNCHANGED) ================= */
const $ = id => document.getElementById(id);
const statusBox = $('statusBox');

function status(msg, level='info'){
  const time = new Date().toLocaleTimeString();
  statusBox.textContent += `\n[${time}] ${msg}`;
  if(level === 'error') statusBox.classList.add('error');
}
function resetStatus(){
  statusBox.textContent = 'Status: idle';
  statusBox.classList.remove('error');
}
function withTimeout(promise, ms=20000){
  let timeout;
  const t = new Promise((_,reject)=>{
    timeout=setTimeout(()=>reject(new Error('Timeout')),ms);
  });
  return Promise.race([promise.finally(()=>clearTimeout(timeout)),t]);
}

/* ================= PHOTO PREVIEW (UNCHANGED) ================= */
const photoInput = $('photoInput');
const photoPreview = $('photoPreview');
$('chooseFileBtn').onclick = () => photoInput.click();

photoInput.onchange = () => {
  const f = photoInput.files[0];
  if(!f) return;
  const r = new FileReader();
  r.onload = e => {
    photoPreview.style.backgroundImage = `url(${e.target.result})`;
    photoPreview.style.backgroundSize = 'cover';
    photoPreview.textContent = '';
  };
  r.readAsDataURL(f);
};

/* ================= FORM SUBMIT (ONLY THIS PART CHANGED) ================= */
$('registerForm').addEventListener('submit', async (ev) => {
  ev.preventDefault();
  resetStatus();

  try {
    const name = $('name').value.trim();
    const email = $('email').value.trim();
    const password = $('password').value;
    const role = $('role').value;

    if(!name || !email || !password){
      alert('Required fields missing');
      return;
    }

    $('registerBtn').disabled = true;

    const cred = await withTimeout(
      createUserWithEmailAndPassword(auth, email, password), 20000
    );

    await updateProfile(cred.user, { displayName: name });

    /* ðŸ”´ ONLY REPLACED BLOCK (Firebase â†’ Cloudinary) */
    let photoURL = '';
    const file = photoInput.files[0];
    if(file){
      status('Uploading photo to Cloudinary...');
      photoURL = await withTimeout(uploadToCloudinary(file), 30000);
      await updateProfile(cred.user, { photoURL });
      status('Photo uploaded');
    }

    await setDoc(doc(db,'users',cred.user.uid),{
      name,
      email,
      role,
      photoURL,
      createdAt: serverTimestamp()
    });

    alert('Account created successfully');
    window.location.replace('login.html');

  } catch(err){
    alert(err.message);
    $('registerBtn').disabled = false;
  }
});
</script>
</body>
</html>
